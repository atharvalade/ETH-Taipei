# Authentica Blockchain Integration

This directory contains the smart contracts and deployment scripts for Authentica's Rootstock and Hyperlane integration.

## Overview

The integration allows users to make payments in BTC via Rootstock (rBTC) and have the verification service executed on World Chain. The flow is as follows:

1. User sends BTC payment to Rootstock address
2. Rootstock contract receives the payment and sends a message to World Chain via Hyperlane
3. World Chain contract receives the message and triggers the verification service

## Project Structure

- `rootstock/` - Contains the Rootstock smart contract
- `worldchain/` - Contains the World Chain smart contract
- `hyperlane/` - Contains Hyperlane bridge configuration
- `scripts/` - Contains deployment scripts

## Prerequisites

- Node.js v16 or higher
- Hardhat
- Private key with funds on both Rootstock testnet and World Chain testnet
- Hyperlane CLI

## Installation

```bash
# Install dependencies
npm install

# Install Hyperlane CLI
npm install -g @hyperlane-xyz/cli
```

## Configuration

Create a `.env` file with the following variables:

```
PRIVATE_KEY=your_private_key_here
WORLD_CHAIN_RPC_URL=https://testnet-rpc.worldchain.cool
WORLD_CHAIN_CONTRACT_ADDRESS=your_deployed_verifier_address
WEBHOOK_URL=your_webhook_url
HYPERLANE_WEBHOOK_API_KEY=your_webhook_api_key
```

## Deployment Steps

### 1. Deploy Hyperlane Core

First, initialize Hyperlane on both chains:

```bash
# Check available chains in the registry
npx @hyperlane-xyz/cli registry list

# Initialize chain configs if needed
npx @hyperlane-xyz/cli registry init

# Deploy Hyperlane core contracts
npx @hyperlane-xyz/cli core deploy
```

### 2. Deploy Warp Route

Deploy the Warp Route using the provided configuration:

```bash
npx @hyperlane-xyz/cli warp deploy --config ./hyperlane/warp-route-deployment.yaml
```

Make note of the deployed mailbox addresses for both chains, as you'll need them in the next steps.

### 3. Deploy Smart Contracts

Update the addresses in the deployment scripts with the actual Hyperlane mailbox addresses.

Deploy to Rootstock testnet:

```bash
npx hardhat run scripts/deploy-rootstock.js --network rootstock-testnet
```

Deploy to World Chain testnet:

```bash
npx hardhat run scripts/deploy-worldchain.js --network worldchain-testnet
```

### 4. Run the Event Listener

Start the event listener to monitor for events from the World Chain contract:

```bash
node scripts/event-listener.js
```

For production, you should run this as a background service using PM2 or a similar tool.

## Testing

### MetaMask Deep Link Testing

You can test the MetaMask deep link by opening the following URL on a mobile device with MetaMask installed:

```
metamask://wc?uri=wc:00000...
```

Replace the URL with the actual deep link generated by the application.

### Transaction Testing

To test a transaction manually:

```bash
node scripts/test-rootstock-payment.js
```

## Smart Contract Functions

### Rootstock Payment Receiver

- `payForVerification(address _userAddress, bytes32 _referenceId)` - Send rBTC payment for verification

### World Chain Payment Verifier

- `handle(uint32 _origin, bytes32 _sender, bytes calldata _body)` - Handles incoming messages from Hyperlane

## Security Considerations

- The contract uses a fixed price of 0.001 rBTC for testing purposes. In production, this should be configurable.
- The contracts should be audited before deploying to production.
- Ensure proper access controls are in place for admin functions. 